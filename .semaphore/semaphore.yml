version: v1.0

name: Continuous Integration Pipeline

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
  containers:
    - name: android-emulator
      image: "budtmo/docker-android"
    - name: appium
      image: "appium/appium"

blocks:
  - name: Setup and Run Emulator
    task:
      jobs:
        - name: Start Android Emulator and Take Screenshot
          commands:
            - checkout
            - docker pull budtmo/docker-android  # Pull latest image
            - docker run -d --privileged -p 6080:6080 -e DEVICE="Nexus_5X_API_30" --name android-emulator budtmo/docker-android
            - echo "Waiting for the Android emulator to fully initialize..."
            - sleep 180  # Wait for the emulator to be fully ready
            - echo "Starting ngrok to expose VNC..."
            - docker exec android-emulator /bin/bash -c "wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip && unzip ngrok-stable-linux-amd64.zip && mv ngrok /usr/local/bin"
            
            # Add the ngrok authtoken to authenticate with your ngrok account
            - docker exec android-emulator /bin/bash -c "ngrok authtoken 2gaat4S18SY42iMHadpLGAGKTf8_4SJ6uBXQ7r1QDzKDwe5YA"

            - docker exec android-emulator /bin/bash -c "ngrok tcp 5900"
            - echo "ngrok tunnel established. Use the following URL to access the VNC server:"
            - docker exec android-emulator /bin/bash -c "curl http://localhost:4040/api/tunnels"  # Show ngrok URL
            - echo "Starting Appium server..."
            - docker exec appium /bin/bash -c "npm install -g appium"  # Install Appium if not installed
            - docker exec appium /bin/bash -c "appium &"  # Start Appium server
            - echo "Appium server started."
            - sleep 10  # Give Appium time to start

            # Take a screenshot using Appium (or ADB commands)
            - docker exec appium /bin/bash -c "node capture_screenshot.js"
            - echo "Screenshot taken and saved."
            - artifact push /tmp/screenshot.png
            - echo "Screenshot stored successfully."

  - name: Cleanup
    task:
      jobs:
        - name: Stop Emulator and Clean Up
          commands:
            - echo "Stopping emulator..."
            - docker stop android-emulator
            - docker rm android-emulator
            - echo "Emulator stopped and container removed."
