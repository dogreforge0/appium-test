version: v1.0

name: Continuous Integration Pipeline

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
  containers:
    - name: android-emulator
      image: "budtmo/docker-android"
    - name: appium
      image: "appium/appium"

blocks:
  - name: Setup and Run Emulator
    task:
      jobs:
        - name: Start Android Emulator and Take Screenshot
          commands:
            - checkout
            - docker pull budtmo/docker-android  # Pull latest image
            - docker run -d --privileged -p 6080:6080 -e DEVICE="Nexus_5X_API_30" --name android-emulator budtmo/docker-android
            - echo "Waiting for the Android emulator to fully initialize..."
            - sleep 180  # Increase the wait time for emulator startup
            - echo "Starting Appium server..."
            - docker exec appium /bin/bash -c "npm install -g appium"  # Install Appium if not installed
            - docker exec appium /bin/bash -c "appium &"  # Start Appium server
            - echo "Appium server started."
            - sleep 10  # Give Appium time to start

            # Take a screenshot using Appium (or ADB commands)
            - docker exec appium /bin/bash -c "node capture_screenshot.js"
            - echo "Screenshot taken and saved."
            - artifact push /tmp/screenshot.png
            - echo "Screenshot stored successfully."

  - name: Cleanup
    task:
      jobs:
        - name: Stop Emulator and Clean Up
          commands:
            - echo "Stopping emulator..."
            - docker stop android-emulator
            - docker rm android-emulator
            - echo "Emulator stopped and container removed."
